{% extends 'base.html' %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <a href="{% url 'public_booking' %}" class="text-decoration-none text-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver a etapas
            </a>
        </div>
    </div>

    <div class="row justify-content-center">
        <!-- Columna Izquierda: Info -->
        <div class="col-12 col-md-3 mb-4">
            <div class="mb-4">
                <h3 class="h4 mb-3">{{ stage.name }}</h3>
                <div class="d-flex align-items-center text-secondary mb-2">
                    <i class="far fa-clock me-2"></i>
                    <span class="fs-6">30 min</span>
                </div>
                <div class="d-flex align-items-start text-secondary">
                    <i class="fas fa-map-marker-alt me-2 mt-1"></i>
                    <span class="fs-6">Avenida Padre Claret, 3<br>Segovia</span>
                </div>
            </div>
        </div>

        <!-- Columna Central: Calendario -->
        <div class="col-12 col-md-5">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="d-flex align-items-center border-bottom p-4">
                        <div class="flex-grow-1 text-center">
                            <h5 class="mb-0 fw-normal" id="currentMonth">enero 2025</h5>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm nav-btn" id="prevMonth">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="btn btn-sm nav-btn" id="nextMonth">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div id="calendar"></div>
                </div>
            </div>
        </div>

        <!-- Columna Derecha: Slots -->
        <div class="col-12 col-md-3" id="timeSlotsColumn">
            <div class="px-3">
                <div class="mb-4">
                    <h6 class="text-secondary fw-normal" id="selectedDate"></h6>
                    <div class="timezone-info">
                        <i class="far fa-clock"></i>
                        <span>Zona horaria</span>
                        <select class="timezone-select">
                            <option>Europa Central</option>
                        </select>
                    </div>
                </div>
                <div id="slots-container" class="d-grid gap-2">
                    <!-- Los slots se insertan aquí -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* 1. Base Container */
.container-fluid {
    max-width: 1200px;
}

/* 2. FullCalendar Overrides */
.fc {
    --fc-border-color: transparent;
    --fc-day-today-bg-color: transparent;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    font-size: 0.9rem;
}

.fc .fc-toolbar {
    display: none;
}

.fc .fc-col-header-cell {
    padding: 8px 0;
    text-transform: uppercase;
    font-weight: 500;
    color: #666;
    border: none;
    font-size: 0.75rem;
}

.fc .fc-daygrid-day {
    border: none !important;
}

.fc .fc-daygrid-day-frame {
    min-height: 46px;
    padding: 4px;
}

.fc .fc-daygrid-day-top {
    justify-content: center;
    padding-top: 2px;
}

.fc .fc-daygrid-day-number {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    margin: 2px auto;
    border-radius: 50%;
    float: none;
    font-size: 0.95rem;
    color: #1a1a1a;
    text-decoration: none;
}

.fc .fc-day-today .fc-daygrid-day-number {
    font-weight: 500;
    background: none;
}

.fc .fc-day-past {
    opacity: 0.5;
    pointer-events: none;
}

.fc .fc-day-other .fc-daygrid-day-number {
    color: #ccc;
}

.fc .fc-day-has-slots .fc-daygrid-day-number {
    background-color: rgba(0, 105, 255, 0.1);
    color: #0969da;
}

.fc .fc-day-future:not(.fc-day-other):hover .fc-daygrid-day-number {
    background-color: rgba(0, 105, 255, 0.1);
    color: #0969da;
    cursor: pointer;
}

.fc .selected-day .fc-daygrid-day-number {
    background-color: #0969da !important;
    color: white !important;
}

/* 3. Navigation */
.nav-btn {
    padding: 0.4rem 0.6rem;
    color: #666;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 4px;
    transition: all 0.15s ease;
}

.nav-btn:hover {
    color: #0969da;
    border-color: #0969da;
}

/* 4. Time Slots Column */
#timeSlotsColumn {
    display: none;
}

#timeSlotsColumn.show {
    display: block;
    animation: slideIn 0.3s ease forwards;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* 5. Timezone Info */
.timezone-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
    font-size: 0.8125rem;
    color: #666;
}

.timezone-select {
    appearance: none;
    background: transparent;
    border: none;
    font-size: 0.8125rem;
    color: #0969da;
    cursor: pointer;
    padding-right: 1rem;
}

/* 6. Slots Container */
#slots-container .btn {
    color: #0969da;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    padding: 12px;
    text-align: center;
    font-size: 0.9375rem;
    font-weight: 500;
    transition: all 0.15s ease;
}

#slots-container .btn:hover {
    color: white;
    background: #0969da;
    border-color: #0969da;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(9,105,218,0.1);
}

#selectedDate {
    font-size: 0.9375rem;
    text-transform: capitalize;
    margin: 0;
    color: #666;
}

/* 7. Loading States */
.loading-spinner {
    width: 24px;
    height: 24px;
    border: 2px solid #e5e7eb;
    border-top-color: #0969da;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 2rem auto;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.error-message, 
.no-slots-message {
    text-align: center;
    color: #666;
    padding: 2rem 0;
}

.error-message i,
.no-slots-message i {
    font-size: 24px;
    margin-bottom: 1rem;
    display: block;
    opacity: 0.5;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. Inicialización y configuración básica
    console.log('DEBUG - Page loaded');
    
    const monthNames = [
        'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
        'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
    ];

    // 2. Configuración del calendario
    const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'dayGridMonth',
        locale: 'es',
        height: 'auto',
        headerToolbar: false,
        dayHeaderFormat: { weekday: 'short' },
        fixedWeekCount: false,
        showNonCurrentDates: true,
        selectable: true,
        unselectAuto: false,
        selectConstraint: {
            start: new Date(),
            end: new Date(new Date().setMonth(new Date().getMonth() + 3))
        },
        datesSet: function(info) {
            console.log('DEBUG - Calendar month changed');
            const currentDate = info.view.currentStart;
            document.getElementById('currentMonth').textContent = 
                monthNames[currentDate.getMonth()] + ' ' + currentDate.getFullYear();
            loadAvailableDates();
        },
        select: function(info) {
            console.log('DEBUG - Date selected:', info.startStr);
            // No hacemos nada aquí para evitar duplicación
        },
        dateClick: function(info) {
            console.log('DEBUG - Date clicked:', info.dateStr);
            const clickedDay = document.querySelector(`.fc-day[data-date="${info.dateStr}"]`);
            if (clickedDay && clickedDay.classList.contains('fc-day-has-slots')) {
                handleDateSelection({ startStr: info.dateStr });
            }
        },
        eventDidMount: function(info) {
            // Si es el día actual y tiene slots, cargarlos
            const today = new Date().toISOString().split('T')[0];
            if (info.event.startStr === today) {
                const todayCell = document.querySelector(`.fc-day[data-date="${today}"]`);
                if (todayCell && todayCell.classList.contains('fc-day-has-slots')) {
                    handleDateSelection({ startStr: today });
                }
            }
        }
    });
    
    // 3. Inicialización del calendario
    calendar.render();
    
    // 4. Navegación del calendario
    document.getElementById('prevMonth').onclick = () => calendar.prev();
    document.getElementById('nextMonth').onclick = () => calendar.next();
    
    // 5. Variable de control para cargas múltiples
    let currentlyLoadingDate = null;

    // 6. Función para cargar días disponibles
    async function loadAvailableDates() {
        console.log('DEBUG - Loading available dates');
        try {
            document.querySelectorAll('.fc-day-has-slots').forEach(day => {
                day.classList.remove('fc-day-has-slots');
            });
            
            const response = await fetch(`/api/stage/{{ stage.id }}/availability/`);
            console.log('DEBUG - Available dates response status:', response.status);
            
            if (!response.ok) throw new Error('Error cargando fechas');
            
            const availableDates = await response.json();
            console.log('DEBUG - Available dates:', availableDates);
            
            availableDates.forEach(dateInfo => {
                const cell = document.querySelector(`.fc-day[data-date="${dateInfo.date}"]`);
                if (cell) {
                    cell.classList.add('fc-day-has-slots');
                    console.log('DEBUG - Marked date as available:', dateInfo.date);
                }
            });

            // Manejar día actual solo si estamos en el mes actual
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = calendar.view.currentStart;
            const nextMonth = new Date(currentMonth);
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            
            const todayDate = new Date(today);
            if (todayDate >= currentMonth && todayDate < nextMonth) {
                const todayCell = document.querySelector(`.fc-day[data-date="${today}"]`);
                if (todayCell && todayCell.classList.contains('fc-day-has-slots')) {
                    handleDateSelection({ startStr: today });
                }
            }
            
        } catch (error) {
            console.error('DEBUG - Error loading dates:', error);
        }
    }
    
    // 7. Función para cargar slots de un día específico
    async function loadTimeSlots(date) {
        const formattedDate = date.toISOString().split('T')[0];
        
        // Prevenir múltiples cargas simultáneas para la misma fecha
        if (currentlyLoadingDate === formattedDate) {
            console.log('DEBUG - Already loading slots for:', formattedDate);
            return;
        }
        
        currentlyLoadingDate = formattedDate;
        console.log('DEBUG - Loading time slots for date:', formattedDate);
        
        const container = document.getElementById('slots-container');
        const timeSlotsColumn = document.getElementById('timeSlotsColumn');
        
        // Mostrar loading
        container.innerHTML = '<div class="loading-spinner"></div>';
        timeSlotsColumn.style.display = 'block';
        
        try {
            const url = `/api/stage/{{ stage.id }}/availability/?date=${formattedDate}`;
            console.log('DEBUG - Fetching URL:', url);
            
            const response = await fetch(url);
            console.log('DEBUG - Response status:', response.status);
            
            if (!response.ok) throw new Error('Error en la respuesta del servidor');
            
            const slots = await response.json();
            console.log('DEBUG - Received slots:', slots);
            
            container.innerHTML = '';
            
            if (!slots.length) {
                console.log('DEBUG - No slots available');
                container.innerHTML = `
                    <div class="no-slots-message">
                        <i class="fas fa-calendar-times"></i>
                        <p>No hay horarios disponibles</p>
                    </div>`;
                timeSlotsColumn.classList.add('show');
                return;
            }
            
            slots.forEach(slot => {
                console.log('DEBUG - Creating button for slot:', slot);
                const button = document.createElement('button');
                button.className = 'btn w-100 mb-2';
                button.innerHTML = slot.time;
                button.onclick = () => window.location.href = `/stage/{{ stage.id }}/book/${slot.id}/`;
                container.appendChild(button);
            });
            
            timeSlotsColumn.classList.add('show');
            
        } catch (error) {
            console.error('DEBUG - Error loading slots:', error);
            container.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>Error cargando horarios</p>
                </div>`;
        } finally {
            currentlyLoadingDate = null;
        }
    }
    
    // 8. Función para manejar la selección de fecha
    function handleDateSelection(info) {
        console.log('DEBUG - Handling date selection:', info);
        
        const date = new Date(info.startStr);
        const formattedDate = date.toLocaleDateString('es', {
            weekday: 'long',
            day: 'numeric',
            month: 'long'
        }).toLowerCase();
        
        document.getElementById('selectedDate').textContent = formattedDate;
        
        // Resaltar día seleccionado
        document.querySelectorAll('.fc-day').forEach(day => {
            day.classList.remove('selected-day');
        });
        
        const selectedDay = document.querySelector(`.fc-day[data-date="${info.startStr}"]`);
        if (selectedDay) {
            selectedDay.classList.add('selected-day');
            console.log('DEBUG - Day marked as selected:', info.startStr);
        }
        
        // Cargar slots
        loadTimeSlots(date);
    }
});
</script>
{% endblock %}